var e={11:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),o=a.n(n),l=a(54),r=a.n(l)()(o());r.push([e.id,'.block[data-v-61feb2a2]{display:flex;flex-direction:column;gap:5px;margin:10px 0}.flex-container[data-v-61feb2a2]{display:flex;gap:10px;align-items:center}.flex-container>select[data-v-61feb2a2]{flex-grow:1}.button-group[data-v-61feb2a2]{display:flex;flex-direction:row;gap:10px;align-items:center;margin:10px 0}.menu_button[data-v-61feb2a2]{white-space:nowrap}\n','']);const i=r},42:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a}},54:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a='',n=void 0!==t[5];return t[4]&&(a+='@supports ('.concat(t[4],') {')),t[2]&&(a+='@media '.concat(t[2],' {')),n&&(a+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),a+=e(t),n&&(a+='}'),t[2]&&(a+='}'),t[4]&&(a+='}'),a}).join('')},t.i=function(e,a,n,o,l){'string'==typeof e&&(e=[[null,e,void 0]]);var r={};if(n)for(var i=0;i<this.length;i++){var s=this[i][0];null!=s&&(r[s]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);n&&r[d[0]]||(void 0!==l&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=l),a&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=a):d[2]=a),o&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=o):d[4]=''.concat(o)),t.push(d))}},t}},93:e=>{e.exports=function(e){return e[1]}},112:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var n=a(93),o=a.n(n),l=a(54),r=a.n(l)()(o());r.push([e.id,'.custom-slider[data-v-a8181f9c]{position:relative;width:100%;height:20px;display:flex;align-items:center;cursor:pointer;-webkit-tap-highlight-color:transparent}.track[data-v-a8181f9c]{position:absolute;width:100%;height:4px;background-color:#555;border-radius:2px}.track-fill[data-v-a8181f9c]{height:100%;background-color:#4CAF50;border-radius:2px}.thumb[data-v-a8181f9c]{position:absolute;width:16px;height:16px;background-color:#f1f1f1;border:2px solid #4CAF50;border-radius:50%;transform:translateX(-50%);z-index:1;box-shadow:0 1px 3px rgba(0,0,0,0.2)}\n','']);const i=r},305:(e,t,a)=>{var n=a(112);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('02cb4604',n,!1,{ssrId:!0})},424:(e,t,a)=>{function n(e,t){for(var a=[],n={},o=0;o<t.length;o++){var l=t[o],r=l[0],i={id:e+':'+o,css:l[1],media:l[2],sourceMap:l[3]};n[r]?n[r].parts.push(i):a.push(n[r]={id:r,parts:[i]})}return a}a.d(t,{A:()=>v});var o='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!o)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var l={},r=o&&(document.head||document.getElementsByTagName('head')[0]),i=null,s=0,c=!1,d=function(){},u=null,m='data-vue-ssr-id',p='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function v(e,t,a,o){c=a,u=o||{};var r=n(e,t);return f(r),function(t){for(var a=[],o=0;o<r.length;o++){var i=r[o];(s=l[i.id]).refs--,a.push(s)}t?f(r=n(e,t)):r=[];for(o=0;o<a.length;o++){var s;if(0===(s=a[o]).refs){for(var c=0;c<s.parts.length;c++)s.parts[c]();delete l[s.id]}}}}function f(e){for(var t=0;t<e.length;t++){var a=e[t],n=l[a.id];if(n){n.refs++;for(var o=0;o<n.parts.length;o++)n.parts[o](a.parts[o]);for(;o<a.parts.length;o++)n.parts.push(h(a.parts[o]));n.parts.length>a.parts.length&&(n.parts.length=a.parts.length)}else{var r=[];for(o=0;o<a.parts.length;o++)r.push(h(a.parts[o]));l[a.id]={id:a.id,refs:1,parts:r}}}}function g(){var e=document.createElement('style');return e.type='text/css',r.appendChild(e),e}function h(e){var t,a,n=document.querySelector('style['+m+'~="'+e.id+'"]');if(n){if(c)return d;n.parentNode.removeChild(n)}if(p){var o=s++;n=i||(i=g()),t=w.bind(null,n,o,!1),a=w.bind(null,n,o,!0)}else n=g(),t=x.bind(null,n),a=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else a()}}var b,V=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function w(e,t,a,n){var o=a?'':n.css;if(e.styleSheet)e.styleSheet.cssText=V(t,o);else{var l=document.createTextNode(o),r=e.childNodes;r[t]&&e.removeChild(r[t]),r.length?e.insertBefore(l,r[t]):e.appendChild(l)}}function x(e,t){var a=t.css,n=t.media,o=t.sourceMap;if(n&&e.setAttribute('media',n),u.ssrId&&e.setAttribute(m,t.id),o&&(a+='\n/*# sourceURL='+o.sources[0]+' */',a+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(o))))+' */'),e.styleSheet)e.styleSheet.cssText=a;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(a))}}},958:(e,t,a)=>{var n=a(11);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(424).A)('491d49f1',n,!1,{ssrId:!0})}},t={};function a(n){var o=t[n];if(void 0!==o)return o.exports;var l=t[n]={id:n,exports:{}};return e[n](l,l.exports,a),l.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const n=Vue,o={class:'track'},l=(0,n.defineComponent)({__name:'CustomSlider',props:{modelValue:{},min:{},max:{},step:{}},emits:['update:modelValue'],setup(e,{emit:t}){const a=e,l=t,r=(0,n.ref)(null),i=(0,n.computed)(()=>{const e=a.max-a.min;return 0===e?0:(a.modelValue-a.min)/e}),s=(0,n.computed)(()=>100*Math.max(0,Math.min(1,i.value))+'%');function c(e){if(!r.value)return;const t=r.value.getBoundingClientRect(),n=Math.max(0,Math.min(1,(e-t.left)/t.width));const o=(a.min+n*(a.max-a.min)-a.min)/a.step,i=Math.round(o);let s=a.min+i*a.step;if(s=Math.max(a.min,Math.min(a.max,s)),s!==a.modelValue){const e=String(a.step).split('.')[1]?.length||0;l('update:modelValue',parseFloat(s.toFixed(e)))}}function d(e){c(e.clientX)}function u(e){c('touches'in e?e.touches[0].clientX:e.clientX)}function m(){window.removeEventListener('mousemove',u),window.removeEventListener('touchmove',u),window.removeEventListener('mouseup',m),window.removeEventListener('touchend',m)}function p(){window.addEventListener('mousemove',u),window.addEventListener('touchmove',u),window.addEventListener('mouseup',m),window.addEventListener('touchend',m)}return(0,n.onUnmounted)(()=>{m()}),(e,t)=>((0,n.openBlock)(),(0,n.createElementBlock)('div',{ref_key:'sliderRef',ref:r,class:'custom-slider',onClick:d},[(0,n.createElementVNode)('div',o,[(0,n.createElementVNode)('div',{class:'track-fill',style:(0,n.normalizeStyle)({width:s.value})},null,4)]),(0,n.createElementVNode)('div',{class:'thumb',style:(0,n.normalizeStyle)({left:s.value}),onMousedown:(0,n.withModifiers)(p,['prevent']),onTouchstart:(0,n.withModifiers)(p,['prevent'])},null,36)],512))}});a(305);var r=a(42);const i=(0,r.A)(l,[['__scopeId','data-v-a8181f9c']]),s=z,c=s.z.object({autoOptimize:s.z.boolean().default(!1),apiProvider:s.z.enum(['openai','openai_test','google','sillytavern_backend','sillytavern_preset']).default('openai'),apiUrl:s.z.string().url().optional().or(s.z.literal('')).default(''),apiKey:s.z.string().default(''),modelName:s.z.string().default(''),autoFetchModels:s.z.boolean().default(!1),disabledWords:s.z.string().default(''),regexFilters:s.z.string().default(['<StatusPlaceHolderImpl\\/>','\\s*\x3c!--[\\s\\S]*?--\x3e\\s*','(<disclaimer>.*?<\\/disclaimer>)|(<guifan>.*?<\\/guifan>)|```start|<content>|<\\/content>|```end|<done>|`<done>`|(\x3c!--\\s*consider\\s*:\\s*(.*?)\\s*--\x3e)|(.*?<\\/think(ing)?>(\\n)?)|(<think(ing)?>[\\s\\S]*?<\\/think(ing)?>(\\n)?)','/<UpdateVariable>[\\s\\S]*?<\\/UpdateVariable>/gm'].join('\n')),disableNotifications:s.z.boolean().default(!1),temperature:s.z.number().min(0).max(2).default(.7),max_tokens:s.z.number().int().positive().default(2e3),top_p:s.z.number().min(0).max(1).default(1),top_k:s.z.number().int().positive().optional(),promptSettings:s.z.object({main:s.z.string().default(''),system:s.z.string().default(''),final_system:s.z.string().default('')}).default({main:'你是一个专业的剧情优化助手。',system:'请根据用户的要求，优化提供的句子，使其更生动、更具描述性。',final_system:'只返回优化后的句子，不要包含任何额外的解释或标签。'})}),d=c.parse({});async function u(){const e=await TavernHelper.getVariables({type:'script'});return c.parse(e.settings||{})}const{getChatMessages:m,setChatMessages:p,generate:v,getLastMessageId:f}=TavernHelper;async function g(e,t){(await u()).disableNotifications&&'error'!==e||toastr[e](t)}async function h(e){if(!(await u()).autoOptimize)return;if(e!==await f())return;const t=await m(e);if(!t||0===t.length)return;const a=t[0];await b(a.message)&&await N()}async function b(e){const t=await u(),a=V(e,t),n=(t.disabledWords||'').split(',').map(e=>e.trim()).filter(Boolean);return 0!==n.length&&n.some(e=>{const t=e.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&');return new RegExp(t,'i').test(a)})}function V(e,t){const a=t.regexFilters||'';if(!a.trim())return e;const n=a.split('\n').map(e=>e.trim()).filter(e=>e.length>0);let o=e;for(const e of n)try{let t=e,a='gs';const n=e.match(/^\/(.*)\/([gimsuy]*)$/);n&&(t=n[1],a=''!==n[2]?n[2]:a);const l=new RegExp(t,a);o=o.replace(l,'')}catch(t){console.error(`[AI Optimizer] 无效的正则表达式: "${e}"`,t)}return o.trim()}async function w(e,t){g('info','正在发送给AI进行优化...');try{const a=await v({user_input:`待优化句子：\n${e}`,injects:[{role:'system',content:t,position:'in_chat',depth:0}]});return g('success','优化完成。'),a??''}catch(e){return console.error(e),g('error','优化失败，请查看控制台日志。'),''}}async function x(e,t,a){const n=await f(),o=await m(n);if(!o||0===o.length)return void g('error','未找到可替换的消息。');const l=o[0],r=e.split('\n').map(e=>e.replace(/^\d+[.)]\s*/,'').trim()).filter(Boolean),i=(t.match(/\d+[.)]\s*.*?(?=\s*\d+[.)]|$)/g)||[]).map(e=>e.replace(/^\d+[.)]\s*/,'').trim()).filter(Boolean);let s=l.message;if(r.length!==i.length){g('warning','AI返回的句子数量与原始数量不匹配，将尝试整体替换。');const e=r[0];if(!s.includes(e))return void g('error','找不到原始句子的起始位置，无法执行替换。');s=s.replace(e,t);for(let e=1;e<r.length;e++)s=s.replace(r[e],'')}else r.forEach((e,t)=>{const a=i[t];a&&(s=s.replace(e,a))});a(s),await p([{message_id:l.message_id,message:s}]),g('success','消息已成功替换！')}async function E(e){const t=await u(),a=await f(),n=await m(a);if(!n||0===n.length)return g('error','聊天记录为空，无法优化。'),void e('');const o=V(n[0].message,t),l=(t.disabledWords||'').split(',').map(e=>e.trim()).filter(Boolean);if(0===l.length)return g('warning','未设置禁用词，无法提取。'),void e('');const r=function(e,t){const a=e.match(/[^.!?。！？]+[.!?。！？]?/g)||[e],n=new Set;return t.forEach(e=>{const t=e.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&'),o=new RegExp(t,'i');a.forEach(e=>{if(o.test(e)){let t=e.replace(/[\r\n]/g,' ').trim();t=t.replace(/\*/g,''),t=t.replace(/^[\s"'“‘]+|[\s"'”’]+$/g,'').trim();const a=t.lastIndexOf('……');-1!==a&&a+2<t.length&&(t=t.substring(a+2)),t=t.replace(/^[\s"'“‘]+/,'').trim(),n.add(t)}})}),Array.from(n)}(o,l);if(r.length>0){g('success','已提取待优化内容。');e(r.map((e,t)=>`${t+1}. ${e}`).join('\n'))}else g('info','在最后一条角色消息中未找到包含禁用词的句子。'),e('')}async function N(){try{g('info','自动化优化流程已启动...');const e=await u(),t=await new Promise(e=>{E(e)});if(!t)return;const a=function(e){const t=(e.disabledWords||'').split(',').map(e=>e.trim()).filter(Boolean),{main:a,system:n,final_system:o}=e.promptSettings;return[a,n,`必须避免使用这些词：[${t.join(', ')}]`,o].filter(Boolean).join('\n')}(e),n=await w(t,a);if(!n)throw new Error('AI 未能返回优化后的文本。');await x(t,n,()=>{}),g('success','自动优化完成！')}catch(e){console.error('[Auto Optimizer] 流程执行出错:',e),g('error',e.message)}}async function y(){const e=await f(),t=await m(e);return t&&t.length>0?t[0].message:''}const k={class:'ai-optimizer-settings'},M={class:'inline-drawer'},I={class:'inline-drawer-content'},A={class:'block'},S={class:'block'},C={class:'block'},T={class:'block'},U={class:'block'},B={class:'block'},D={class:'block'},O={class:'button-group'},P={key:0,style:{color:'green'}},R={key:1,style:{color:'red'}},j={class:'block'},L=['value'],F=['value'],H={class:'checkbox_label'},W={class:'block'},G={class:'block'},K={class:'block'},X={class:'button-group'},q={class:'checkbox_label'},J={class:'checkbox_label'},Q={class:'block'},Y={class:'block'},Z={class:'block'},ee={class:'block'},te=(0,n.defineComponent)({__name:'Panel',setup(e){const t=(0,n.ref)(d),a=(0,n.ref)([]),o=(0,n.ref)('unknown'),l=(0,n.ref)('main'),r=(0,n.ref)(''),s=(0,n.ref)(''),c=(0,n.ref)(''),m=(0,n.ref)('');let p,f=(0,n.ref)('');(0,n.watch)(t,e=>{!async function(e){const t={...await u(),...e};await TavernHelper.updateVariablesWith(()=>({settings:t}),{type:'script'})}(e)},{deep:!0}),(0,n.watch)(m,(e,a)=>{t.value.autoOptimize&&e&&e!==f.value&&b(e)&&(console.log('[AI Optimizer] Detected disabled word in new message, triggering auto-optimization.'),f.value=e,N())});const h=()=>{r.value&&s.value?x(r.value,s.value,e=>{c.value=e}):toastr.warning('“待优化内容”和“优化后内容”都不能为空。')},V=async()=>{if(r.value){toastr.info('正在发送给AI进行优化...');try{const e=await w(r.value,t.value.promptSettings[l.value]);s.value=e,toastr.success('优化完成。')}catch(e){console.error(e),toastr.error('优化失败，请查看控制台日志。')}}else toastr.warning('待优化内容不能为空。')},E=async()=>{toastr.info('正在获取模型列表...');try{const e=await async function(){return g('info','酒馆助手脚本模式下无法自动获取模型列表。'),['gpt-4','gpt-3.5-turbo','claude-3-opus-20240229','gemini-pro']}();e.length>0?(a.value=e,toastr.success(`成功获取 ${e.length} 个模型。`)):toastr.warning('未能获取到模型列表，请检查设置或控制台日志。')}catch(e){console.error(e),toastr.error('获取模型时发生未知错误。')}},te=async()=>{o.value='unknown',toastr.info('正在测试连接...');try{const e=await async function(){try{return await v({user_input:'test',max_chat_history:0}),g('success','API 连接成功！'),!0}catch(e){return g('error','API 连接失败。'),!1}}();o.value=e?'success':'error',e?toastr.success('API 连接成功！'):toastr.error('API 连接失败，请检查设置和控制台日志。')}catch(e){o.value='error',toastr.error('API 连接测试时发生错误。'),console.error(e)}};return(0,n.onMounted)(async()=>{t.value=await u(),t.value.autoFetchModels&&E(),m.value=y(),console.log('[AI Optimizer] Initial lastCharMessage:',m.value),p=window.setInterval(()=>{const e=y();e!==m.value&&(m.value=e,console.log('[AI Optimizer] lastCharMessage updated.'))},3e3)}),(0,n.onUnmounted)(()=>{p&&clearInterval(p)}),(e,d)=>((0,n.openBlock)(),(0,n.createElementBlock)('div',k,[(0,n.createElementVNode)('div',M,[d[45]||(d[45]=(0,n.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,n.createElementVNode)('b',null,'AI 文本优化助手'),(0,n.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,n.createElementVNode)('div',I,[(0,n.createCommentVNode)(' 生成设置 '),d[38]||(d[38]=(0,n.createElementVNode)('b',null,'生成设置',-1)),(0,n.createElementVNode)('div',A,[(0,n.createElementVNode)('label',null,'Temperature ('+(0,n.toDisplayString)(t.value.temperature)+')',1),(0,n.createVNode)(i,{modelValue:t.value.temperature,'onUpdate:modelValue':d[0]||(d[0]=e=>t.value.temperature=e),min:0,max:2,step:.01},null,8,['modelValue'])]),(0,n.createElementVNode)('div',S,[d[20]||(d[20]=(0,n.createElementVNode)('label',null,'Max Tokens',-1)),(0,n.withDirectives)((0,n.createElementVNode)('input',{'onUpdate:modelValue':d[1]||(d[1]=e=>t.value.max_tokens=e),class:'text_pole',type:'number'},null,512),[[n.vModelText,t.value.max_tokens,void 0,{number:!0}]])]),(0,n.createElementVNode)('div',C,[(0,n.createElementVNode)('label',null,'Top P ('+(0,n.toDisplayString)(t.value.top_p)+')',1),(0,n.createVNode)(i,{modelValue:t.value.top_p,'onUpdate:modelValue':d[2]||(d[2]=e=>t.value.top_p=e),min:0,max:1,step:.01},null,8,['modelValue'])]),(0,n.createElementVNode)('div',T,[d[21]||(d[21]=(0,n.createElementVNode)('label',null,'Top K',-1)),(0,n.withDirectives)((0,n.createElementVNode)('input',{'onUpdate:modelValue':d[3]||(d[3]=e=>t.value.top_k=e),class:'text_pole',type:'number'},null,512),[[n.vModelText,t.value.top_k,void 0,{number:!0}]])]),d[39]||(d[39]=(0,n.createElementVNode)('hr',{class:'sysHR'},null,-1)),(0,n.createCommentVNode)(' API 设置 '),d[40]||(d[40]=(0,n.createElementVNode)('b',null,'API 设置',-1)),(0,n.createElementVNode)('div',U,[d[23]||(d[23]=(0,n.createElementVNode)('label',null,'API 提供商',-1)),(0,n.withDirectives)((0,n.createElementVNode)('select',{'onUpdate:modelValue':d[4]||(d[4]=e=>t.value.apiProvider=e),class:'text_pole'},[...d[22]||(d[22]=[(0,n.createStaticVNode)('<option value="openai" data-v-61feb2a2>OpenAI</option><option value="openai_test" data-v-61feb2a2>OpenAI (测试)</option><option value="google" data-v-61feb2a2>Google</option><option value="sillytavern_backend" data-v-61feb2a2>SillyTavern (后端)</option><option value="sillytavern_preset" data-v-61feb2a2>SillyTavern (预设)</option>',5)])],512),[[n.vModelSelect,t.value.apiProvider]])]),(0,n.createElementVNode)('div',B,[d[24]||(d[24]=(0,n.createElementVNode)('label',null,'API URL',-1)),(0,n.withDirectives)((0,n.createElementVNode)('input',{'onUpdate:modelValue':d[5]||(d[5]=e=>t.value.apiUrl=e),class:'text_pole',type:'text',placeholder:'例如: https://api.openai.com/v1'},null,512),[[n.vModelText,t.value.apiUrl]])]),(0,n.createElementVNode)('div',D,[d[25]||(d[25]=(0,n.createElementVNode)('label',null,'API 密钥',-1)),(0,n.withDirectives)((0,n.createElementVNode)('input',{'onUpdate:modelValue':d[6]||(d[6]=e=>t.value.apiKey=e),class:'text_pole',type:'password'},null,512),[[n.vModelText,t.value.apiKey]])]),(0,n.createElementVNode)('div',O,[(0,n.createElementVNode)('button',{class:'menu_button',onClick:te},'测试连接'),(0,n.createElementVNode)('button',{class:'menu_button',onClick:E},'获取模型'),'success'===o.value?((0,n.openBlock)(),(0,n.createElementBlock)('span',P,'连接成功！')):(0,n.createCommentVNode)('v-if',!0),'error'===o.value?((0,n.openBlock)(),(0,n.createElementBlock)('span',R,'连接失败。')):(0,n.createCommentVNode)('v-if',!0)]),(0,n.createElementVNode)('div',j,[d[27]||(d[27]=(0,n.createElementVNode)('label',null,'模型名称',-1)),(0,n.withDirectives)((0,n.createElementVNode)('select',{'onUpdate:modelValue':d[7]||(d[7]=e=>t.value.modelName=e),class:'text_pole'},[t.value.modelName&&!a.value.includes(t.value.modelName)?((0,n.openBlock)(),(0,n.createElementBlock)('option',{key:0,value:t.value.modelName},(0,n.toDisplayString)(t.value.modelName)+' (自定义) ',9,L)):(0,n.createCommentVNode)('v-if',!0),((0,n.openBlock)(!0),(0,n.createElementBlock)(n.Fragment,null,(0,n.renderList)(a.value,e=>((0,n.openBlock)(),(0,n.createElementBlock)('option',{key:e,value:e},(0,n.toDisplayString)(e),9,F))),128))],512),[[n.vModelSelect,t.value.modelName]]),(0,n.createElementVNode)('label',H,[(0,n.withDirectives)((0,n.createElementVNode)('input',{'onUpdate:modelValue':d[8]||(d[8]=e=>t.value.autoFetchModels=e),type:'checkbox'},null,512),[[n.vModelCheckbox,t.value.autoFetchModels]]),d[26]||(d[26]=(0,n.createTextVNode)(' 每次加载时自动获取 ',-1))])]),d[41]||(d[41]=(0,n.createElementVNode)('hr',{class:'sysHR'},null,-1)),(0,n.createCommentVNode)(' 禁用词设置 '),d[42]||(d[42]=(0,n.createElementVNode)('b',null,'禁用词与优化',-1)),(0,n.createElementVNode)('div',W,[d[28]||(d[28]=(0,n.createElementVNode)('label',null,'禁用词列表 (用英文逗号 , 分隔)',-1)),(0,n.withDirectives)((0,n.createElementVNode)('textarea',{'onUpdate:modelValue':d[9]||(d[9]=e=>t.value.disabledWords=e),class:'text_pole',rows:'3'},null,512),[[n.vModelText,t.value.disabledWords]])]),(0,n.createElementVNode)('div',G,[d[29]||(d[29]=(0,n.createElementVNode)('label',null,'正则表达式过滤器 (每行一个)',-1)),(0,n.withDirectives)((0,n.createElementVNode)('textarea',{'onUpdate:modelValue':d[10]||(d[10]=e=>t.value.regexFilters=e),class:'text_pole',rows:'5'},null,512),[[n.vModelText,t.value.regexFilters]])]),(0,n.createElementVNode)('div',K,[d[30]||(d[30]=(0,n.createElementVNode)('label',null,'最后一条角色消息 (自动刷新)',-1)),(0,n.withDirectives)((0,n.createElementVNode)('textarea',{'onUpdate:modelValue':d[11]||(d[11]=e=>m.value=e),class:'text_pole',rows:'4',readonly:''},null,512),[[n.vModelText,m.value]])]),(0,n.createElementVNode)('div',X,[(0,n.createElementVNode)('button',{class:'menu_button',onClick:d[12]||(d[12]=(...e)=>(0,n.unref)(N)&&(0,n.unref)(N)(...e))},'一键全自动优化'),(0,n.createElementVNode)('label',q,[(0,n.withDirectives)((0,n.createElementVNode)('input',{'onUpdate:modelValue':d[13]||(d[13]=e=>t.value.autoOptimize=e),type:'checkbox'},null,512),[[n.vModelCheckbox,t.value.autoOptimize]]),d[31]||(d[31]=(0,n.createTextVNode)(' 自动优化 ',-1))]),(0,n.createElementVNode)('label',J,[(0,n.withDirectives)((0,n.createElementVNode)('input',{'onUpdate:modelValue':d[14]||(d[14]=e=>t.value.disableNotifications=e),type:'checkbox'},null,512),[[n.vModelCheckbox,t.value.disableNotifications]]),d[32]||(d[32]=(0,n.createTextVNode)(' 关闭大部分通知 ',-1))])]),(0,n.createElementVNode)('div',Q,[d[33]||(d[33]=(0,n.createElementVNode)('label',null,'待优化内容',-1)),(0,n.withDirectives)((0,n.createElementVNode)('textarea',{'onUpdate:modelValue':d[15]||(d[15]=e=>r.value=e),class:'text_pole',rows:'4'},null,512),[[n.vModelText,r.value]])]),(0,n.createElementVNode)('div',{class:'button-group'},[(0,n.createElementVNode)('button',{class:'menu_button',onClick:V},'优化')]),(0,n.createElementVNode)('div',Y,[d[34]||(d[34]=(0,n.createElementVNode)('label',null,'优化后内容',-1)),(0,n.withDirectives)((0,n.createElementVNode)('textarea',{'onUpdate:modelValue':d[16]||(d[16]=e=>s.value=e),class:'text_pole',rows:'4'},null,512),[[n.vModelText,s.value]])]),(0,n.createElementVNode)('div',{class:'button-group'},[(0,n.createElementVNode)('button',{class:'menu_button',onClick:h},'替换')]),(0,n.createElementVNode)('div',Z,[d[35]||(d[35]=(0,n.createElementVNode)('label',null,'修改后的消息内容 (测试)',-1)),(0,n.withDirectives)((0,n.createElementVNode)('textarea',{'onUpdate:modelValue':d[17]||(d[17]=e=>c.value=e),class:'text_pole',rows:'6'},null,512),[[n.vModelText,c.value]])]),d[43]||(d[43]=(0,n.createElementVNode)('hr',{class:'sysHR'},null,-1)),(0,n.createCommentVNode)(' 提示词编写器 '),d[44]||(d[44]=(0,n.createElementVNode)('b',null,'提示词编写器',-1)),(0,n.createElementVNode)('div',ee,[d[37]||(d[37]=(0,n.createElementVNode)('label',null,'选择编辑的提示词:',-1)),(0,n.withDirectives)((0,n.createElementVNode)('select',{'onUpdate:modelValue':d[18]||(d[18]=e=>l.value=e),class:'text_pole'},[...d[36]||(d[36]=[(0,n.createElementVNode)('option',{value:'main'},'主系统提示词 (通用)',-1),(0,n.createElementVNode)('option',{value:'system'},'拦截任务详细指令',-1),(0,n.createElementVNode)('option',{value:'final_system'},'最终注入指令',-1)])],512),[[n.vModelSelect,l.value]]),(0,n.withDirectives)((0,n.createElementVNode)('textarea',{'onUpdate:modelValue':d[19]||(d[19]=e=>t.value.promptSettings[l.value]=e),class:'text_pole',rows:'6'},null,512),[[n.vModelText,t.value.promptSettings[l.value]]])])])])]))}});a(958);const ae=(0,r.A)(te,[['__scopeId','data-v-61feb2a2']]);let ne=null;$(()=>{new Promise((e,t)=>{let a=0;const n=setInterval(()=>{window.parent.document.getElementById('send_form')?(clearInterval(n),e()):(a++,a>=100&&(clearInterval(n),t(new Error('Timeout waiting for #send_form in parent document'))))},200)}).then(()=>{eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,h),g('success','AI 文本优化助手已加载！');const e=$('<div>').attr('script_id',getScriptId());$('#extensions_settings2').append(e),ne=(0,n.createApp)(ae),ne.mount(e[0])}).catch(e=>{console.error('[AI Optimizer] Initialization failed:',e)})}),$(window).on('unload',()=>{ne&&ne.unmount(),$(`div[script_id="${getScriptId()}"]`).remove()});